<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product</title>
</head>
<body>
    <h1 id="product-name"></h1>
    <p>Price: <span id="product-price"></span></p>
    <p>Stock: <span id="product-stock"></span></p>
    <p>Description: <span id="product-description"></span></p>

    <hr>

    <h2>Update Product (Admin)</h2>
    <form id="update-product-form">
        <div>
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div>
            <label for="price">Price</label>
            <input type="number" id="price" name="price" required>
        </div>
        <div>
            <label for="stock">Stock</label>
            <input type="number" id="stock" name="stock" required>
        </div>
        <div>
            <label for="description">Description</label>
            <textarea id="description" name="description"></textarea>
        </div>
        <button type="submit">Update</button>
    </form>

    <script>
        function decodeJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        function isAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                return false;
            }
            const decodedToken = decodeJwt(token);
            return decodedToken && decodedToken.auth && decodedToken.auth.includes('ROLE_ADMIN');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        async function fetchProduct() {
            const response = await fetch(`/api/products/${productId}`);
            const product = await response.json();

            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-price').textContent = product.price;
            document.getElementById('product-stock').textContent = product.stock;
            document.getElementById('product-description').textContent = product.description;

            document.getElementById('name').value = product.name;
            document.getElementById('price').value = product.price;
            document.getElementById('stock').value = product.stock;
            document.getElementById('description').value = product.description;
        }

        document.getElementById('update-product-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!isAdmin()) {
                alert('관리자만 상품을 수정할 수 있습니다.');
                return;
            }

            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const stock = document.getElementById('stock').value;
            const description = document.getElementById('description').value;
            const token = localStorage.getItem('token');

            const response = await fetch(`/api/admin/products/${productId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, price, stock, description })
            });

            if (response.ok) {
                alert('Product updated successfully!');
                fetchProduct();
            } else {
                const error = await response.json();
                alert('Product update failed: ' + error.message);
            }
        });

        if (productId) {
            fetchProduct();
        }
    </script>
</body>
</html>